# Data Model: Document Upload and Management

**Feature**: 002-document-upload  
**Date**: 2026-01-28  
**Source**: Feature specification and research findings

## Entity Overview

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│      User       │       │     Project     │       │    TaskItem     │
│  (existing)     │       │   (existing)    │       │   (existing)    │
└────────┬────────┘       └────────┬────────┘       └────────┬────────┘
         │                         │                         │
         │ 1:N                     │ 1:N                     │ N:M
         │                         │                         │
         ▼                         ▼                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                            Document                                  │
│  - DocumentId (PK)                                                   │
│  - Title, Description, Category, Tags                               │
│  - FilePath, OriginalFileName, FileSize, FileType                   │
│  - UploadDate, UploadedById (FK→User)                              │
│  - ProjectId (FK→Project, optional)                                 │
└────────┬────────────────────────────────────────┬───────────────────┘
         │ 1:N                                     │ 1:N
         ▼                                         ▼
┌─────────────────┐                       ┌─────────────────┐
│  DocumentShare  │                       │DocumentAuditLog │
│  - ShareId (PK) │                       │  - LogId (PK)   │
│  - DocumentId   │                       │  - DocumentId   │
│  - SharedWithId │                       │  - Action       │
│  - SharedById   │                       │  - UserId       │
│  - SharedDate   │                       │  - Timestamp    │
└─────────────────┘                       └─────────────────┘
```

---

## Entity: Document

The primary entity storing document metadata. Files are stored on filesystem; this entity tracks metadata and location.

### Attributes

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `DocumentId` | `int` | PK, Identity | Unique document identifier |
| `Title` | `string` | Required, MaxLength(200) | User-provided document title |
| `Description` | `string?` | MaxLength(2000) | Optional description |
| `Category` | `string` | Required, MaxLength(50) | Category from predefined list |
| `Tags` | `string?` | MaxLength(500) | Comma-separated tags for search |
| `FilePath` | `string` | Required, MaxLength(500) | Storage path (GUID-based) |
| `OriginalFileName` | `string` | Required, MaxLength(255) | Original uploaded filename |
| `FileSize` | `long` | Required | File size in bytes |
| `FileType` | `string` | Required, MaxLength(255) | MIME type (e.g., "application/pdf") |
| `UploadDate` | `DateTime` | Required | UTC timestamp of upload |
| `UploadedById` | `int` | FK→User, Required | User who uploaded document |
| `ProjectId` | `int?` | FK→Project, Optional | Associated project (if any) |

### Relationships

- **UploadedBy** → User (Many-to-One): Each document has one uploader
- **Project** → Project (Many-to-One, Optional): Document may belong to a project
- **Shares** → DocumentShare (One-to-Many): Document can be shared with multiple users
- **AuditLogs** → DocumentAuditLog (One-to-Many): All operations logged

### Indexes

```csharp
modelBuilder.Entity<Document>()
    .HasIndex(d => d.UploadedById);           // Fast lookup by owner
modelBuilder.Entity<Document>()
    .HasIndex(d => d.ProjectId);              // Fast lookup by project
modelBuilder.Entity<Document>()
    .HasIndex(d => d.Category);               // Fast filtering by category
modelBuilder.Entity<Document>()
    .HasIndex(d => d.UploadDate);             // Fast sorting by date
```

### Validation Rules

- Title: 1-200 characters, required
- Category: Must be one of predefined values
- FileSize: Maximum 26,214,400 bytes (25 MB)
- FileType: Must be in allowed MIME types list
- FilePath: GUID-based, generated by system (never user input)

### Predefined Categories

```csharp
public static readonly string[] ValidCategories = 
{
    "Project Documents",
    "Team Resources", 
    "Personal Files",
    "Reports",
    "Presentations",
    "Other"
};
```

### Allowed File Types

```csharp
public static readonly Dictionary<string, string> AllowedFileTypes = new()
{
    { ".pdf", "application/pdf" },
    { ".docx", "application/vnd.openxmlformats-officedocument.wordprocessingml.document" },
    { ".xlsx", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" },
    { ".pptx", "application/vnd.openxmlformats-officedocument.presentationml.presentation" },
    { ".txt", "text/plain" },
    { ".jpg", "image/jpeg" },
    { ".jpeg", "image/jpeg" },
    { ".png", "image/png" }
};
```

---

## Entity: DocumentShare

Junction entity tracking document sharing between users.

### Attributes

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `ShareId` | `int` | PK, Identity | Unique share identifier |
| `DocumentId` | `int` | FK→Document, Required | Shared document |
| `SharedWithUserId` | `int` | FK→User, Required | Recipient user |
| `SharedByUserId` | `int` | FK→User, Required | User who shared |
| `SharedDate` | `DateTime` | Required | UTC timestamp of share |

### Relationships

- **Document** → Document (Many-to-One): The shared document
- **SharedWithUser** → User (Many-to-One): User receiving access
- **SharedByUser** → User (Many-to-One): User granting access

### Indexes

```csharp
modelBuilder.Entity<DocumentShare>()
    .HasIndex(ds => ds.SharedWithUserId);     // Fast lookup of shared documents
modelBuilder.Entity<DocumentShare>()
    .HasIndex(ds => new { ds.DocumentId, ds.SharedWithUserId })
    .IsUnique();                               // Prevent duplicate shares
```

### Validation Rules

- SharedWithUserId cannot equal document owner
- SharedWithUserId cannot equal SharedByUserId
- Document must exist and sharer must have access

---

## Entity: DocumentAuditLog

Immutable log of all document operations for compliance and audit.

### Attributes

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `LogId` | `int` | PK, Identity | Unique log identifier |
| `DocumentId` | `int` | FK→Document, Required | Affected document |
| `Action` | `string` | Required, MaxLength(50) | Action type (enum as string) |
| `UserId` | `int` | FK→User, Required | User who performed action |
| `Timestamp` | `DateTime` | Required | UTC timestamp of action |
| `Details` | `string?` | MaxLength(500) | Additional context (e.g., shared with username) |

### Action Types

```csharp
public static class DocumentAuditActions
{
    public const string Upload = "Upload";
    public const string Download = "Download";
    public const string Preview = "Preview";
    public const string Edit = "Edit";
    public const string Replace = "Replace";
    public const string Delete = "Delete";
    public const string Share = "Share";
    public const string Unshare = "Unshare";
}
```

### Indexes

```csharp
modelBuilder.Entity<DocumentAuditLog>()
    .HasIndex(l => l.DocumentId);             // Audit trail per document
modelBuilder.Entity<DocumentAuditLog>()
    .HasIndex(l => l.UserId);                 // User activity report
modelBuilder.Entity<DocumentAuditLog>()
    .HasIndex(l => l.Timestamp);              // Time-based queries
```

### Validation Rules

- Logs are immutable (no update/delete operations)
- Timestamp set by system, never user input
- Action must be from predefined list

---

## State Transitions

### Document Lifecycle

```
┌──────────┐     Upload      ┌──────────┐
│  (none)  │ ───────────────▶│ Created  │
└──────────┘                  └────┬─────┘
                                   │
              ┌────────────────────┼────────────────────┐
              │                    │                    │
              ▼                    ▼                    ▼
        ┌──────────┐         ┌──────────┐        ┌──────────┐
        │  Edited  │         │  Shared  │        │ Replaced │
        └────┬─────┘         └────┬─────┘        └────┬─────┘
              │                    │                    │
              └────────────────────┼────────────────────┘
                                   │
                                   ▼
                            ┌──────────┐
                            │ Deleted  │
                            └──────────┘
```

### Share Lifecycle

```
┌──────────┐     Share       ┌──────────┐
│  (none)  │ ───────────────▶│  Active  │
└──────────┘                  └────┬─────┘
                                   │
                    Unshare or     │
                    Document Delete│
                                   ▼
                            ┌──────────┐
                            │ Removed  │
                            └──────────┘
```

---

## DbContext Integration

```csharp
// Add to ApplicationDbContext.cs
public DbSet<Document> Documents { get; set; } = null!;
public DbSet<DocumentShare> DocumentShares { get; set; } = null!;
public DbSet<DocumentAuditLog> DocumentAuditLogs { get; set; } = null!;
```

---

## Migration Notes

1. **New Tables**: Documents, DocumentShares, DocumentAuditLogs
2. **No Changes**: Existing User, Project, TaskItem tables unchanged
3. **Future Enhancement**: TaskDocument junction table for task attachments (P3 feature)
